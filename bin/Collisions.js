// Generated by CoffeeScript 1.6.3
/*
Handle collisions and conflicts between units.
Look at this for optimisation:
http://goanna.cs.rmit.edu.au/~gl/teaching/rtr&3dgp/notes/data-structures.pdf
*/


(function() {
  window.Collisions = (function() {
    function Collisions() {}

    Collisions.PLAYER_COLLISION_CHECKING_SCHEDULE = 6;

    Collisions.UNIT_COLLISION_CHECKING_SCHEDULE = 5;

    Collisions.UNIT_COLLISION_SENSITIVITY = 40;

    Collisions.playerMatchup = function(players, func, self) {
      var compare_player, inner_checked, outer_checked, player, _i, _len, _results;
      _results = [];
      for (outer_checked = _i = 0, _len = players.length; _i < _len; outer_checked = ++_i) {
        player = players[outer_checked];
        _results.push((function() {
          var _j, _len1, _results1;
          _results1 = [];
          for (inner_checked = _j = 0, _len1 = players.length; _j < _len1; inner_checked = ++_j) {
            compare_player = players[inner_checked];
            if (compare_player === player || outer_checked > inner_checked) {
              continue;
            }
            _results1.push(func.call(self, player, compare_player));
          }
          return _results1;
        })());
      }
      return _results;
    };

    Collisions.resolveCollisions = function(combat_players) {
      var matchup_number, self;
      matchup_number = 0;
      self = this;
      return this.playerMatchup(combat_players, function(player, compare_player) {
        var compare_to_units, units;
        if (ticks % Collisions.PLAYER_COLLISION_CHECKING_SCHEDULE === matchup_number || matchup_number > Collisions.PLAYER_COLLISION_CHECKING_SCHEDULE) {
          compare_to_units = compare_player.getUnits();
          units = player.getUnits();
          self.compareUnits(units, compare_to_units, player, compare_player);
        }
        return matchup_number++;
      }, this);
    };

    Collisions.compareUnits = function(units, compare_to_units, player, compare_player) {
      var compare_unit, inner_checked, outer_checked, unit, _i, _len, _ref, _results;
      _ref = units.getAll();
      _results = [];
      for (outer_checked = _i = 0, _len = _ref.length; _i < _len; outer_checked = ++_i) {
        unit = _ref[outer_checked];
        _results.push((function() {
          var _j, _len1, _ref1, _results1;
          _ref1 = compare_to_units.getAll();
          _results1 = [];
          for (inner_checked = _j = 0, _len1 = _ref1.length; _j < _len1; inner_checked = ++_j) {
            compare_unit = _ref1[inner_checked];
            if (this.unitsIntersecting(unit, compare_unit)) {
              units.remove(unit);
              compare_to_units.remove(compare_unit);
              break;
            } else {
              _results1.push(void 0);
            }
          }
          return _results1;
        }).call(this));
      }
      return _results;
    };

    Collisions.unitsIntersecting = function(unit, compare_unit) {
      return unit.getPosition().distanceFrom(compare_unit.getPosition()) < Collisions.UNIT_COLLISION_SENSITIVITY;
    };

    return Collisions;

  })();

}).call(this);
